\<!DOCTYPE html>
{% extends 'superadmin/base.html' %}
{% load custom_filters %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h3 class="card-title text-center">{{ form.instance.pk|yesno:"Update Lead,Create Lead" }}</h3>
                </div>
                {% if messages %}
                <div class="m-3">
                    {% for message in messages %}
                        <div class="alert alert-warning">{{ message }}</div>
                    {% endfor %}
                </div>
                {% endif %}
                <form id="lead-form" method="post" enctype="multipart/form-data" action="{% if form.instance.pk %}{% url 'superadmin:lead_update' form.instance.pk %}{% else %}{% url 'superadmin:lead_create' %}{% endif %}">
                    {% csrf_token %}
                    <div class="card-body p-3">
                        {{ form.non_field_errors }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.project_name.id_for_label }}">Project Name</label>
                                    {{ form.project_name|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-project_name"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.company.id_for_label }}">Company</label>
                                    {{ form.company|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-company"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.email.id_for_label }}">Email</label>
                                    {{ form.email|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-email"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.phone.id_for_label }}">Phone</label>
                                    {{ form.phone|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-phone"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.project_type.id_for_label }}">Project Type</label>
                                    {{ form.project_type|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-project_type"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.location.id_for_label }}">Location</label>
                                    {{ form.location|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-location"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.Timeline.id_for_label }}">Timeline</label>
                                    {{ form.Timeline|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-Timeline"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.budget.id_for_label }}">Budget</label>
                                    {{ form.budget|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-budget"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="{{ form.description.id_for_label }}">Description</label>
                            {{ form.description|add_class:"form-control form-control-sm" }}
                            <div class="text-danger small" id="error-description"></div>
                        </div>
                        <div class="form-group">
                            <label for="dropzone">Images</label>
                            <div id="dropzone" class="dropzone"></div>
                            <div class="text-danger small" id="error-dropzone"></div>
                        </div>
                    </div>
                    <div class="card-footer text-right">
                        <button type="submit" id="submit-button" class="btn btn-primary btn-sm">Submit</button>
                        <a href="{% url 'superadmin:lead_list' %}" class="btn btn-secondary btn-sm">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Get the CSRF token from the form's hidden input
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    // Ensure Dropzone is not automatically discovering and processing elements
    Dropzone.autoDiscover = false;

    var dropzone = new Dropzone("#dropzone", {
        url: "{% url 'superadmin:upload_lead_filess' %}", // URL for uploading files
        paramName: "file", // The name that will be used to transfer the file
        maxFilesize: 2, // MB
        addRemoveLinks: true,
        dictDefaultMessage: "Drag files here or click to upload",
        autoProcessQueue: false, // Prevent auto-processing; we'll manually process the queue
        parallelUploads: 10, // Number of files to process simultaneously
        headers: {
            "X-CSRFToken": getCSRFToken() // Add CSRF token to headers
        },
        init: function() {
            var myDropzone = this;

            // Handle form submission
            document.querySelector("#submit-button").addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Clear previous errors
                document.querySelectorAll('.text-danger').forEach(el => el.textContent = '');

                var leadForm = document.querySelector("#lead-form");
                var formData = new FormData(leadForm);

                // Submit the form via AJAX
                fetch(leadForm.action, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": getCSRFToken() // Add CSRF token to headers
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.lead_id) {
                        if (myDropzone.getQueuedFiles().length > 0) {
                            myDropzone.options.params = { lead_id: data.lead_id };
                            myDropzone.processQueue();
                        } else {
                            window.location.href = "{% url 'superadmin:lead_list' %}";
                        }
                    } else if (data.errors) {
                        for (let [field, messages] of Object.entries(data.errors)) {
                            let errorElement = document.getElementById(`error-${field}`);
                            if (errorElement) {
                                errorElement.textContent = messages.join(', ');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                });
            });

            // Handle successful uploads
            myDropzone.on("queuecomplete", function() {
                // Redirect to the lead list or show a success message
                // window.location.href = "{% url 'superadmin:lead_list' %}";
            });

            // Handle errors during file upload
            myDropzone.on("error", function(file, response) {
                let dropzoneErrorElement = document.getElementById('error-dropzone');
                if (dropzoneErrorElement) {
                    dropzoneErrorElement.textContent = response;
                }
                console.error("Error uploading file:", response);
            });
        }
    });
</script>
{% endblock extra_scripts %}
