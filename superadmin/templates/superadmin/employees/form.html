{% extends 'superadmin/base.html' %}
{% load custom_filters %}
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h3 class="card-title text-center">{{ form.instance.pk|yesno:"Update Employee,Create Employee" }}</h3>
                </div>

                {% if messages %}
                    <div id="message-container" class="m-3">
                        {% for message in messages %}
                            <div class="alert alert-warning">{{ message }}</div>
                        {% endfor %}
                    </div>
                {% endif %}

                <form id="employee-form" method="post" enctype="multipart/form-data" action="{% if form.instance.pk %}{% url 'superadmin:employee_update' form.instance.pk %}{% else %}{% url 'superadmin:employee_create' %}{% endif %}">
                    {% csrf_token %}
                    <div class="card-body p-3">
                        {{ form.non_field_errors }}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.first_name.id_for_label }}">First Name</label>
                                    {{ form.first_name|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-first_name"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.last_name.id_for_label }}">Last Name</label>
                                    {{ form.last_name|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-last_name"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.email.id_for_label }}">Email</label>
                                    {{ form.email|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-email"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.phone.id_for_label }}">Phone</label>
                                    {{ form.phone|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-phone"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.joining_date.id_for_label }}">Joining Date</label>
                                    {{ form.joining_date|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-joining_date"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="{{ form.salary.id_for_label }}">Salary</label>
                                    {{ form.salary|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-salary"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="{{ form.designation.id_for_label }}">Designation</label>
                                    {{ form.designation|add_class:"form-control form-control-sm" }}
                                    <div class="text-danger small" id="error-designation"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="dropzone">Images</label>
                                    <div id="dropzone" class="dropzone"></div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-right">
                        <button type="submit" id="submit-button" class="btn btn-primary btn-sm">Submit</button>
                        <a href="{% url 'superadmin:employee_list' %}" class="btn btn-secondary btn-sm">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_scripts %}
<script>
    // Get the CSRF token from the form's hidden input
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    // Ensure Dropzone is not automatically discovering and processing elements
    Dropzone.autoDiscover = false;

    var dropzone = new Dropzone("#dropzone", {
        url: "{% url 'superadmin:upload_employee_images' %}", // URL for uploading images
        paramName: "file", // The name that will be used to transfer the file
        maxFilesize: 2, // MB
        addRemoveLinks: true,
        dictDefaultMessage: "Drag files here or click to upload",
        autoProcessQueue: false, // Prevent auto-processing; we'll manually process the queue
        parallelUploads: 10, // Number of files to process simultaneously
        headers: {
            "X-CSRFToken": getCSRFToken() // Add CSRF token to headers
        },
        init: function() {
            var myDropzone = this;

            // Handle form submission
            document.querySelector("#submit-button").addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();

                var employeeForm = document.querySelector("#employee-form");
                var formData = new FormData(employeeForm);

                // Submit the form via AJAX
                fetch(employeeForm.action, {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": getCSRFToken() // Add CSRF token to headers
                    },
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        return response.json().then(data => { throw data; });
                    }
                })
                .then(data => {
                    if (data.employee_id) {
                        if (myDropzone.getQueuedFiles().length > 0) {
                            myDropzone.options.params = { employee_id: data.employee_id };
                            myDropzone.processQueue();
                        } else {
                            window.location.href = "{% url 'superadmin:employee_list' %}";
                        }
                    } else if (data.errors) {
                        for (let [field, messages] of Object.entries(data.errors)) {
                            let errorElement = document.getElementById(`error-${field}`);
                            if (errorElement) {
                                errorElement.textContent = messages.join(', ');
                            }
                        }
                    }
                })
                .catch(data => {
                    if (data.errors) {
                        for (let [field, messages] of Object.entries(data.errors)) {
                            let errorElement = document.getElementById(`error-${field}`);
                            if (errorElement) {
                                errorElement.textContent = messages.join(', ');
                            }
                        }
                    } else {
                        console.error("Unexpected error:", data);
                    }
                });
            });

            // Handle successful uploads
            myDropzone.on("queuecomplete", function() {
                // Redirect to the employee list or show a success message
                window.location.href = "{% url 'superadmin:employee_list' %}";
            });

            // Handle errors during file upload
            myDropzone.on("error", function(file, response) {
                console.error("Error uploading file:", response);
            });
        }
    });
</script>
{% endblock extra_scripts %}
